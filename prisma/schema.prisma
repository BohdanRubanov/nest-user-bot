// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  //added to generate commonjs module format
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  
}
model TgUser {
  id        Int   @id @default(autoincrement())   
  telegramId   BigInt   @unique
  username     String?
  firstName    String?
  lastName     String?
  languageCode String?
  isBot        Boolean?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  // one-to-many relation with TgEvent
  events       TgEvent[]
}

model TgChat {
  id        Int   @id @default(autoincrement())   
  telegramId  BigInt   @unique
  type        String?
  title       String?
  username    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  // one-to-many relation with TgEvent
  events      TgEvent[]
}

model TgEvent {
  id        Int   @id @default(autoincrement())  
  // is unique to prevent duplicate events
  updateId  BigInt? @unique
  eventType String
  messageId BigInt?
  // Unix timestamp of the message
  dateUnix  Int?
  messageText String?
  userId    Int?
  chatId    Int?
  user      TgUser?  @relation(fields: [userId], references: [id])
  chat      TgChat?  @relation(fields: [chatId], references: [id])
  // Raw JSON payload of the event
  raw       Json  

  createdAt DateTime @default(now())
  // Add index on eventType and createdAt for faster querying by type and date
  @@index([eventType, createdAt])
  @@index([updateId])
}
